<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.9, viewport-fit=cover" />
<link href="youtube_sample_globals.css" rel="stylesheet"/>
<link href="yotuube_sample.css" rel="stylesheet"/>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
    background: #000;
  }
  #container {
    height: calc(var(--vh, 1vh) * 100);
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
  }
  #container::-webkit-scrollbar { display: none; }
  .video {
    position: relative;
    scroll-snap-align: end;
    height: 100vh;
    max-width: 500px;
    overflow: hidden;
    margin: 0 auto;
  }
  .video video.video-bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  /* Toast */
  .toast {
    position: fixed; top: 20px; left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(20,20,20,0.9);
    color: #fff;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 14px;
    opacity: 0;
    z-index: 9999;
    pointer-events: none;
    transition: opacity .2s ease, transform .2s ease;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  /* Bottom Sheet */
  .sheet-backdrop {
    position: fixed; inset:0;
    background: rgba(0,0,0,.4);
    opacity:0; pointer-events:none;
    transition: opacity .2s ease;
    z-index: 9997;
  }
  .sheet-backdrop.open { opacity:1; pointer-events:auto; }
  .sheet {
    position: fixed; left:0; right:0; bottom:-70vh;
    background:#111; color:#fff;
    border-top-left-radius: 14px; border-top-right-radius: 14px;
    box-shadow:0 -8px 30px rgba(0,0,0,.5);
    transition: bottom .25s ease;
    z-index:9998;
    padding:14px 16px;
    max-height:70vh; overflow:auto;
  }
  .sheet.open { bottom:0; }
  .sheet-title { font-weight:700; margin-bottom:10px; }
  .sheet-list { display:grid; gap:8px; }
  .sheet-item {
    border:1px solid rgba(255,255,255,0.15);
    border-radius:10px;
    background:rgba(255,255,255,0.08);
    padding:10px 12px;
    cursor:pointer;
  }
  .sheet-item:active { transform:translateY(1px); }
</style>
</head>
<body>
<div id="container">
  <!-- 원본 비디오 카드들 -->
  <div class="video">
    <video class="video-bg" autoplay loop muted playsinline>
      <source src="sample.mp4" type="video/mp4">
    </video>
    <div class="title-text">샘플 영상</div>
    <div class="id-text">ID001</div>
    <div class="music-text">배경음악</div>
    <button class="btn-hide-category">관심없음</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Bottom Sheet -->
<div id="sheet-backdrop" class="sheet-backdrop"></div>
<div id="bottom-sheet" class="sheet" aria-hidden="true">
  <div class="sheet-title">관심없는 이유를 선택하세요</div>
  <div class="sheet-list" id="sheet-list">
    <button class="sheet-item" data-reason="관련 없음">관련 없음</button>
    <button class="sheet-item" data-reason="지루함">지루함</button>
    <button class="sheet-item" data-reason="불쾌함">불쾌함</button>
    <button class="sheet-item" data-reason="기타">기타</button>
  </div>
</div>

<script>
/* ===== Toast ===== */
const toast = document.getElementById('toast');
let toastTimer = null;
function showToast(msg, ms=2000){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toast.classList.remove('show'), ms);
}

/* ===== Bottom Sheet ===== */
const sheet = document.getElementById('bottom-sheet');
const sheetBackdrop = document.getElementById('sheet-backdrop');
const sheetList = document.getElementById('sheet-list');
let pendingCategory = null;

function openBottomSheet(category){
  pendingCategory = category;
  sheet.classList.add('open');
  sheetBackdrop.classList.add('open');
}
function closeBottomSheet(){
  sheet.classList.remove('open');
  sheetBackdrop.classList.remove('open');
  pendingCategory = null;
}
sheetBackdrop.addEventListener('click', closeBottomSheet);

/* ===== 관심없음 로그 ===== */
const LOG_STORAGE_KEY = 'not_interested_logs_v1';
function getNILogs(){ try { return JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]'); } catch { return []; } }
function saveNILogs(logs){ localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); }
function logNotInterested({ reason, category, row }){
  const now = new Date();
  const entry = {
    ts_iso: now.toISOString(),
    ts_local: now.toLocaleString(),
    reason,
    category: category ?? '',
    title: row?.TITLE ?? '',
    id: row?.ID ?? '',
    music: row?.MUSIC ?? '',
    video_url: row?.['MP4 URL'] ?? ''
  };
  const logs = getNILogs(); logs.push(entry); saveNILogs(logs);
  console.debug('[NI LOG]', entry);
}
function exportNILogsToCSV(){
  const logs = getNILogs();
  if(!logs.length){ alert('저장된 로그가 없습니다.'); return; }
  const headers = ['ts_iso','ts_local','reason','category','title','id','music','video_url'];
  const rows = logs.map(o => headers.map(h => (String(o[h] ?? '')).replaceAll('"','""')));
  const csv = [headers.join(','), ...rows.map(r => `"${r.join('","')}"`)].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const d = new Date();
  a.href = url; a.download = `not_interested_logs_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
window.exportNI = { get:getNILogs, exportCSV:exportNILogsToCSV };

/* ===== 이벤트 연결 ===== */
document.querySelectorAll('.btn-hide-category').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const card = btn.closest('.video');
    openBottomSheet(card?.dataset.category||'');
  });
});

sheetList.addEventListener('click', (e)=>{
  const btn = e.target.closest('.sheet-item');
  if(!btn) return;
  const reason = btn.dataset.reason;
  const activeCard = document.querySelector('.video'); // 현재 카드
  const row = activeCard ? {
    TITLE: activeCard.querySelector('.title-text')?.textContent||'',
    ID: activeCard.querySelector('.id-text')?.textContent||'',
    MUSIC: activeCard.querySelector('.music-text')?.textContent||'',
    'MP4 URL': activeCard.querySelector('video')?.currentSrc || ''
  } : null;
  logNotInterested({ reason, category: pendingCategory, row });
  closeBottomSheet();
  showToast('피드백이 반영되었습니다.', 2000);
});
</script>
</body>
</html>
