<!-- index.html (전체 코드) -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.9, viewport-fit=cover" />
<title>Shorts Demo with 관심없음 로그</title>
<style>
  :root { --maxw: 500px; }
  html, body { margin:0; padding:0; height:100vh; overflow:hidden; background:#000; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Arial, sans-serif; }
  body { padding-top: env(safe-area-inset-top); }

  #topbar {
    position: fixed; top:0; left:0; right:0; height:48px; display:flex; align-items:center; justify-content:space-between;
    padding:0 12px; background:rgba(0,0,0,0.5); backdrop-filter: blur(6px); z-index:20;
  }
  #topbar .title { font-weight:700; font-size:14px; opacity:.9; }
  #topbar .actions { display:flex; gap:8px; }
  .btn {
    border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.08); color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer;
  }
  .btn:active { transform: translateY(1px); }

  #container {
    position:relative;
    height: calc(var(--vh, 1vh) * 100);
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
  }
  #container::-webkit-scrollbar { display:none; }

  .spacer { height:48px; } /* for topbar */

  .video {
    position: relative;
    scroll-snap-align: end;
    height: calc(100vh - 0px);
    max-width: var(--maxw);
    margin: 0 auto;
    overflow: hidden;
    border-left: 1px solid rgba(255,255,255,.06);
    border-right: 1px solid rgba(255,255,255,.06);
  }
  .video video.video-bg,
  .video .fake-video {
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#111;
  }
  .video .overlay {
    position:absolute; left:0; right:0; bottom:0; padding:16px;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0% , rgba(0,0,0,0.65) 80%);
  }
  .meta { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
  .title-text { font-size:16px; font-weight:700; line-height:1.35; }
  .sub-text { font-size:12px; opacity:.75; }

  .toolbar {
    position:absolute; right:8px; bottom:90px; display:flex; flex-direction:column; gap:10px;
  }
  .tbtn { width:42px; height:42px; border-radius:50%; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18); display:grid; place-items:center; cursor:pointer; font-size:11px; text-align:center; line-height:1.1; padding:4px; }
  .tbtn:active { transform:translateY(1px); }
  .tbtn small { opacity:.8; display:block; margin-top:2px; font-size:10px; }

  /* Bottom Sheet */
  .sheet-backdrop {
    position:fixed; inset:0; background:rgba(0,0,0,.4); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:30;
  }
  .sheet {
    position:fixed; left:50%; transform:translateX(-50%); right:0; bottom:-70vh; width:100%; max-width:var(--maxw);
    background:#111; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 30px rgba(0,0,0,.5);
    transition: bottom .25s ease; z-index:31;
  }
  .sheet-header { padding:14px 16px 8px; border-bottom:1px solid rgba(255,255,255,.06); }
  .sheet-title { font-weight:700; font-size:14px; }
  .sheet-list { display:grid; grid-template-columns:1fr; gap:8px; padding:12px 16px 16px; max-height:50vh; overflow:auto; }
  .sheet-item {
    border:1px solid rgba(255,255,255,.16); background:#171717; padding:10px 12px; border-radius:12px; font-size:13px; cursor:pointer;
  }
  .sheet-item:active { transform: translateY(1px); background:#1e1e1e; }

  .sheet-open .sheet-backdrop { opacity:1; pointer-events:auto; }
  .sheet-open .sheet { bottom:0; }

  /* Toast */
  .toast {
    position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:rgba(20,20,20,.9); border:1px solid rgba(255,255,255,.15);
    color:#fff; padding:10px 12px; border-radius:10px; font-size:12px; z-index:40; opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .toast.show { opacity:1; }

  /* Hidden helper */
  .sr { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; }

  /* Empty state (필요시) */
  .empty { display:none; height:calc(100vh - 48px); align-items:center; justify-content:center; flex-direction:column; gap:10px; color:#bbb; }
  .empty.show { display:flex; }
</style>
</head>
<body>

  <div id="topbar">
    <div class="title">Demo · 관심없음 + 타임스탬프 로그</div>
    <div class="actions">
      <button class="btn" id="btnExport">CSV 내보내기</button>
      <button class="btn" id="btnClear">로그 비우기</button>
    </div>
  </div>

  <div id="container" tabindex="0" aria-label="동영상 목록">
    <div class="spacer" aria-hidden="true"></div>
    <!-- 동영상 카드들이 JS로 렌더링됩니다 -->
    <div id="list"></div>
    <div class="empty" id="emptyState">
      <div>표시할 동영상이 없습니다.</div>
      <button class="btn" id="resetHidden">숨김 해제</button>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop" aria-hidden="true"></div>
  <div class="sheet" id="bottomSheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="sheet-header">
      <div class="sheet-title" id="sheetTitle">왜 관심없음을 선택했나요?</div>
    </div>
    <div class="sheet-list" id="sheetList" role="listbox" aria-label="관심없음 사유 선택">
      <!-- 사유 버튼들 JS로 채움 -->
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
    0) 기본 뷰포트 보정
========================= */
function setVhUnit() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVhUnit();
window.addEventListener('resize', setVhUnit);

/* =========================
    1) 데모 데이터
    - 실제 깃허브 환경에서는 CSV 로드 후
      allVideosCache = parsedRows 형태로 두면 동작합니다.
========================= */
const categories = ['hindi.csv','ive.csv','kdh.csv','overwatch.csv','promise9.csv','sahoor.csv','thai.csv','valorant.csv'];

// 샘플 데이터(구조 예시: CSV 파싱 결과와 비슷하게)
let allVideosCache = [
  { TITLE:'샘플 1', ID:'vid001', MUSIC:'track A', 'MP4 URL':'', _category:'kdh.csv' },
  { TITLE:'샘플 2', ID:'vid002', MUSIC:'track B', 'MP4 URL':'', _category:'valorant.csv' },
  { TITLE:'샘플 3', ID:'vid003', MUSIC:'track C', 'MP4 URL':'', _category:'ive.csv' },
  { TITLE:'샘플 4', ID:'vid004', MUSIC:'track D', 'MP4 URL':'', _category:'kdh.csv' },
  { TITLE:'샘플 5', ID:'vid005', MUSIC:'track E', 'MP4 URL':'', _category:'overwatch.csv' },
];

/* =========================
    2) 숨김 상태(카테고리)
========================= */
const HIDE_KEY = 'hidden_categories_v1';
function getHiddenCats() {
  try { return JSON.parse(localStorage.getItem(HIDE_KEY) || '[]'); } catch { return []; }
}
function setHiddenCats(arr) {
  localStorage.setItem(HIDE_KEY, JSON.stringify(arr ?? []));
}
function isHidden(cat) { return getHiddenCats().includes(cat); }
function hideCategory(cat) {
  const set = new Set(getHiddenCats());
  set.add(cat);
  setHiddenCats([...set]);
  renderList();
}
function resetHidden() {
  setHiddenCats([]);
  renderList();
}

/* =========================
    3) 렌더링
========================= */
const listEl = document.getElementById('list');
const emptyEl = document.getElementById('emptyState');

function renderList() {
  listEl.innerHTML = '';
  const hidden = getHiddenCats();
  const data = allVideosCache.filter(r => !hidden.includes(r._category));
  if (!data.length) {
    emptyEl.classList.add('show');
  } else {
    emptyEl.classList.remove('show');
  }
  for (const row of data) {
    const card = document.createElement('section');
    card.className = 'video';
    card.dataset.category = row._category;
    card.dataset.id = row.ID;

    // 비디오가 없는 환경을 위해 가짜 박스
    const fake = document.createElement('div');
    fake.className = 'fake-video';
    fake.style.background = 'linear-gradient(180deg,#333,#111)';
    fake.innerHTML = `<div class="sr">비디오</div>`;
    card.appendChild(fake);

    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.innerHTML = `
      <div class="meta">
        <div class="title-text">${escapeHtml(row.TITLE || '')}</div>
        <div class="sub-text">카테고리: ${escapeHtml(row._category)} · ID: ${escapeHtml(row.ID||'')}</div>
        <div class="sub-text">음악: ${escapeHtml(row.MUSIC||'')}</div>
      </div>
    `;
    card.appendChild(overlay);

    const tools = document.createElement('div');
    tools.className = 'toolbar';

    const btnNI = document.createElement('button');
    btnNI.className = 'tbtn';
    btnNI.innerHTML = `관심<br/>없음`;
    btnNI.addEventListener('click', ()=>{
      openBottomSheet(row._category);
    });
    tools.appendChild(btnNI);

    const btnMute = document.createElement('button');
    btnMute.className = 'tbtn';
    btnMute.innerHTML = `뮤트<small>토글</small>`;
    btnMute.addEventListener('click', ()=>{
      showToast('데모: 뮤트 토글');
    });
    tools.appendChild(btnMute);

    card.appendChild(tools);
    listEl.appendChild(card);
  }
}

/* =========================
    4) 활성 비디오 탐색
========================= */
function getActiveVideo() {
  // 뷰포트 중앙에 가장 가까운 카드를 active 로 간주
  const cards = [...document.querySelectorAll('.video')];
  if (!cards.length) return null;
  const center = window.innerHeight / 2;
  let best = null, bestDist = Infinity;
  for (const el of cards) {
    const rect = el.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    const dist = Math.abs(mid - center);
    if (dist < bestDist) { bestDist = dist; best = el; }
  }
  return best;
}

/* =========================
    5) Bottom Sheet (관심없음 사유)
========================= */
const reasons = [
  '이 동영상에 관심 없음',
  '이 채널에 관심 없음',
  '이 카테고리 숨기기',
  '중복/이미 봄',
  '부적절/불편함',
  '낚시성/과장',
  '반복 노출됨',
  '기타'
];

let pendingCategory = null;
const sheet = document.getElementById('bottomSheet');
const sheetBackdrop = document.getElementById('sheetBackdrop');
const sheetList = document.getElementById('sheetList');

function fillReasons() {
  sheetList.innerHTML = '';
  reasons.forEach(r => {
    const b = document.createElement('button');
    b.className = 'sheet-item';
    b.setAttribute('role','option');
    b.dataset.reason = r;
    b.textContent = r;
    sheetList.appendChild(b);
  });
}

function openBottomSheet(category) {
  pendingCategory = category || null;
  document.body.classList.add('sheet-open');
  sheetBackdrop.setAttribute('aria-hidden', 'false');
}
function closeBottomSheet() {
  pendingCategory = null;
  document.body.classList.remove('sheet-open');
  sheetBackdrop.setAttribute('aria-hidden', 'true');
}

sheetBackdrop.addEventListener('click', closeBottomSheet);

if (sheetList) sheetList.addEventListener('click', (e)=>{
  const btn = e.target.closest('.sheet-item');
  if(!btn) return;
  const reason = btn.dataset.reason;
  const cat = pendingCategory;

  // 현재 활성 카드 & 해당 데이터 추정
  const activeVideo = getActiveVideo();
  const activeCard  = activeVideo ? activeVideo.closest('.video') : null;
  const row = activeCard
    ? allVideosCache.find(r =>
        r._category === (activeCard.dataset.category || '') &&
        (r.TITLE || '') === (activeCard.querySelector('.title-text')?.textContent || '')
      ) || null
    : null;

  // 로그 적재
  logNotInterested({ reason, category: cat, row });

  closeBottomSheet();

  // 예: "이 카테고리 숨기기" 선택 시 해당 카테고리를 숨김
  if (cat && reason === '이 카테고리 숨기기') {
    hideCategory(cat);
    showToast('해당 카테고리가 숨겨졌습니다.');
  } else {
    showToast('피드백을 반영했어요.');
  }
});

/* =========================
    6) Toast
========================= */
const toastEl = document.getElementById('toast');
let toastTimer = null;
function showToast(msg, ms=2000) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), ms);
}

/* =========================
    7) 관심없음 로그 저장/내보내기
========================= */
const LOG_STORAGE_KEY = 'not_interested_logs_v1';

function getNILogs() {
  try { return JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]'); }
  catch { return []; }
}
function saveNILogs(logs) {
  localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
}
function logNotInterested({ reason, category, row }) {
  const now = new Date();
  const entry = {
    ts_iso: now.toISOString(),        // 기계 읽기용
    ts_local: now.toLocaleString(),   // 사용자 표시용
    reason,
    category,
    title: row?.TITLE ?? '',
    id: row?.ID ?? '',
    music: row?.MUSIC ?? '',
    video_url: row?.['MP4 URL'] ?? ''
  };
  const logs = getNILogs();
  logs.push(entry);
  saveNILogs(logs);
  console.debug('[NI LOG]', entry);
}

function exportNILogsToCSV() {
  const logs = getNILogs();
  if (!logs.length) { showToast('저장된 로그가 없습니다.'); return; }
  const headers = ['ts_iso','ts_local','reason','category','title','id','music','video_url'];
  const rows = logs.map(o => headers.map(h => (String(o[h] ?? '')).replaceAll('"','""')));
  const csv = [headers.join(','), ...rows.map(r => `"${r.join('","')}"`)].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const d = new Date();
  a.download = `not_interested_logs_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// 전역 내보내기 (콘솔에서 사용 가능)
window.exportNI = { get: getNILogs, exportCSV: exportNILogsToCSV };

/* =========================
    8) 유틸
========================= */
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
}

/* =========================
    9) 이벤트 바인딩
========================= */
document.getElementById('btnExport')?.addEventListener('click', exportNILogsToCSV);
document.getElementById('btnClear')?.addEventListener('click', ()=>{
  localStorage.removeItem(LOG_STORAGE_KEY);
  showToast('로그를 비웠습니다.');
});
document.getElementById('resetHidden')?.addEventListener('click', ()=>{
  resetHidden();
  showToast('숨김이 해제되었습니다.');
});

/* =========================
    10) 초기화
========================= */
fillReasons();
renderList();

</script>
</body>
</html>

