<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.9, viewport-fit=cover" />
<link href="youtube_sample_globals.css" rel="stylesheet"/>
<link href="yotuube_sample.css" rel="stylesheet"/>
<style>
  html, body {
    margin: 0; padding: 0;
    height: 100vh; overflow: hidden; background: #000;
  }
  body { padding-top: env(safe-area-inset-top); }
  #container {
    height: calc(var(--vh, 1vh) * 100);
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
  }
  #container::-webkit-scrollbar { display: none; }
  .video {
    position: relative;
    scroll-snap-align: end;
    height: 100vh;
    max-width: 500px;
    overflow: hidden;
  }
  .video video.video-bg {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100vh; object-fit: cover;
    z-index: 0; pointer-events: none;
  }
  .video > * { position: relative; z-index: 1; }
  #loading {
    text-align: center; padding: 8px; background: #fff; color: #333; font-size: .9rem;
  }
</style>
</head>
<body>
<div id="container">
  <!-- 템플릿 -->
  <div class="video" id="video-template">
    <div class="top">
      <!-- 아이콘들은 생략 없이 그대로 두셔도 됩니다 -->
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path fill="white" d="M11.458 2.60449C16.3479 2.60449 20.3123 6.56815 20.3125 11.458C20.3125 13.5275 19.6008 15.43 18.4111 16.9375L22.0908 20.6172C22.4976 21.024 22.4976 21.684 22.0908 22.0908C21.684 22.4976 21.024 22.4976 20.6172 22.0908L16.9375 18.4111C15.43 19.6008 13.5274 20.3125 11.458 20.3125C6.56815 20.3123 2.60449 16.348 2.60449 11.458C2.60465 6.56826 6.56825 2.60466 11.458 2.60449ZM11.458 4.6875C7.71885 4.68767 4.68766 7.71885 4.6875 11.458C4.6875 15.1974 7.71875 18.2293 11.458 18.2295C15.1975 18.2295 18.2295 15.1975 18.2295 11.458C18.2293 7.71874 15.1974 4.6875 11.458 4.6875Z"/></svg>
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path fill="white" d="M12.5 17.708C13.6506 17.708 14.583 18.6414 14.583 19.792C14.5828 20.9425 13.6505 21.875 12.5 21.875C11.3495 21.875 10.4172 20.9425 10.417 19.792C10.417 18.6414 11.3494 17.708 12.5 17.708ZM12.5 10.417C13.6506 10.417 14.583 11.3494 14.583 12.5C14.583 13.6506 13.6506 14.583 12.5 14.583C11.3494 14.583 10.417 13.6506 10.417 12.5C10.417 11.3494 11.3494 10.417 12.5 10.417ZM12.5 3.125C13.6505 3.12501 14.5828 4.05757 14.583 5.20801C14.583 6.3586 13.6506 7.29198 12.5 7.29199C11.3494 7.29199 10.417 6.35861 10.417 5.20801C10.4172 4.05757 11.3495 3.125 12.5 3.125Z"/></svg>
    </div>
    <div class="body">
      <div class="left">
        <div class="id"><div class="ellipse"></div><div class="id-text"></div></div>
        <p class="title-text"></p>
        <div class="music">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="20" fill="none" viewBox="0 0 19 20"><path fill="white" d="M14.25 13.167L14.2373 13.4092C14.1158 14.6069 13.1048 15.542 11.875 15.542C10.5634 15.542 9.50016 14.4786 9.5 13.167C9.5 11.8553 10.5633 10.792 11.875 10.792C12.4839 10.792 13.0377 11.0227 13.458 11.3994V6.1582L7.52051 9.8252V15.542L7.50879 15.7842C7.38733 16.982 6.37532 17.917 5.14551 17.917C3.83407 17.9168 2.77067 16.8535 2.77051 15.542C2.77051 14.2304 3.83397 13.1672 5.14551 13.167C5.75483 13.167 6.30905 13.3982 6.72949 13.7754V7.00879L14.25 2.36328V13.167Z"/></svg>
          <div class="music-text"></div><div class="rectangle-1"></div>
        </div>
      </div>
      <div class="right">
        <button class="button">LIKE</button>
        <button class="button">싫어요</button>
        <button class="button btn-comment">999</button>
        <button class="button btn-hide-category">관심없음</button>
        <div class="rectangle"></div>
      </div>
    </div>
  </div>
  <div id="loading">로딩 중...</div>
</div>

<script>
/* ----------------- 공통 유틸 ----------------- */
function setRealHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setRealHeight);
window.addEventListener('load', setRealHeight);

/* ----------------- 데이터/상태 ----------------- */
let categories = ['tesla','dog','aot'];
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
categories = shuffle(categories);

// 숨김 제어 (2분)
const HIDE_MS = 120000;
// Map<cat, number> : 만료 시각 (timestamp, ms)
const hiddenUntil = new Map();
// Map<cat, number> : setTimeout 핸들
const hiddenTimer = new Map();

const container = document.getElementById('container');
const loading = document.getElementById('loading');
const template = document.getElementById('video-template');
template.removeAttribute('id');
container.removeChild(template);

/* ----------------- CSV 파싱 ----------------- */
function parseCSV(text){
  text = text.replace(/^\uFEFF/,'');
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(',').map(c=>c.trim());
    const o={}; headers.forEach((h,i)=>o[h]=cols[i]||''); return o;
  });
}

/* ----------------- 카테고리 숨김 ----------------- */
function isCategoryHidden(cat){
  if(!hiddenUntil.has(cat)) return false;
  return Date.now() < hiddenUntil.get(cat);
}

function scheduleUnhide(cat){
  // 기존 타이머 정리
  if(hiddenTimer.has(cat)){
    clearTimeout(hiddenTimer.get(cat));
    hiddenTimer.delete(cat);
  }
  const remain = hiddenUntil.get(cat) - Date.now();
  if(remain <= 0){ hiddenUntil.delete(cat); reloadVideos(); return; }
  const t = setTimeout(()=>{
    hiddenUntil.delete(cat);
    hiddenTimer.delete(cat);
    reloadVideos();
  }, remain);
  hiddenTimer.set(cat, t);
}

function hideCategory(cat){
  if(!cat) return;
  // 2분 후 만료시각 설정
  hiddenUntil.set(cat, Date.now() + HIDE_MS);
  scheduleUnhide(cat);

  // 화면에 이미 떠있는 동일 카테고리 카드들 즉시 제거
  [...container.querySelectorAll(`.video[data-category="${cat}"]`)].forEach(el=>{
    const v = el.querySelector('video');
    if(v){ v.pause(); v.src=''; }
    el.remove();
  });

  // 즉시 재렌더(목록에서도 제외)
  reloadVideos();
}

/* ----------------- 포스트 생성 ----------------- */
function createPost(row){
  const cat = row._category || '';
  // 숨김 카테고리는 아예 렌더하지 않음
  if(isCategoryHidden(cat)) return null;

  const post = template.cloneNode(true);
  post.dataset.category = cat;

  const video = document.createElement('video');
  video.className = 'video-bg';
  video.setAttribute('data-src', row['MP4 URL']);
  video.autoplay = true; video.loop = true; video.playsInline = true;
  video.muted = true; video.preload = 'none';
  post.prepend(video);

  const idt = post.querySelector('.id-text'); if(idt) idt.textContent = row['ID'] || '';
  const tt  = post.querySelector('.title-text'); if(tt) tt.textContent = row['TITLE'] || '';
  const mt  = post.querySelector('.music-text'); if(mt) mt.textContent = row['MUSIC'] || '';

  const hideBtn = post.querySelector('.btn-hide-category');
  if(hideBtn){
    hideBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      hideCategory(post.dataset.category);
    });
  }
  return post;
}

/* ----------------- 데이터 로드 ----------------- */
let allVideosCache = [];
async function loadAll(){
  try{
    const results = await Promise.all(categories.map(async cat=>{
      try{
        const res = await fetch(`${cat}.csv`);
        if(!res.ok) throw new Error(`${cat}.csv 로드 실패`);
        const text = await res.text();
        const rows = parseCSV(text).map(r=>({...r,_category:cat}));
        return shuffle(rows); // 카테고리 내부 랜덤
      }catch(e){ console.error(e); return []; }
    }));
    allVideosCache = shuffle(results.flat()); // 전체 랜덤
    reloadVideos();
    loading.style.display='none';
    observeVideos();
  }catch(e){
    console.error('데이터 로드 실패:', e);
    loading.textContent = '데이터를 불러오지 못했습니다.';
  }
}

/* ----------------- 렌더/리로드 ----------------- */
function reloadVideos(){
  container.innerHTML = '';
  for(const row of allVideosCache){
    if(isCategoryHidden(row._category)) continue;
    const post = createPost(row);
    if(post) container.appendChild(post);
  }
  observeVideos();
  applyAudioPolicy();
}

/* ----------------- 오디오 정책 ----------------- */
let userGestureGranted = false;
function getActiveVideo(){
  return document.querySelector('.video video.video-bg[data-active="true"]');
}
function applyAudioPolicy(){
  const vids = document.querySelectorAll('.video video.video-bg');
  const active = getActiveVideo();
  vids.forEach(v=> v.muted = true);
  if(userGestureGranted && active){
    active.muted = false;
    if(active.paused) active.play().catch(()=>{});
  }
}

/* ----------------- IntersectionObserver ----------------- */
let observer;
function observeVideos(){
  if(observer) observer.disconnect();
  observer = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const video = entry.target;
      if(!(video instanceof HTMLVideoElement)) return;
      const post = video.closest('.video');
      const cat = post?.dataset?.category || '';

      // 교차되더라도 숨김 카테고리면 즉시 차단
      if(isCategoryHidden(cat)){
        video.pause();
        video.removeAttribute('data-active');
        // 보수적으로 DOM에서도 제거
        post?.remove();
        return;
      }

      if(entry.isIntersecting){
        if(!video.src && video.dataset.src) video.src = video.dataset.src;
        video.setAttribute('data-active','true');
        document.querySelectorAll('.video video.video-bg').forEach(v=>{ if(v!==video) v.removeAttribute('data-active'); });
        video.play().catch(()=>{});
      }else{
        video.removeAttribute('data-active');
        video.pause();
      }
    });
    applyAudioPolicy();
  }, { threshold: 0.75 });

  document.querySelectorAll('.video video.video-bg').forEach(v=>observer.observe(v));
}

/* ----------------- 스크롤 스냅(한 장씩) ----------------- */
let isScrolling = false;
container.addEventListener('wheel', (e)=>{
  e.preventDefault();
  if(isScrolling) return;
  isScrolling = true;

  const dir = e.deltaY > 0 ? 1 : -1;
  const cards = [...container.querySelectorAll('.video')];
  const y = container.scrollTop;
  const h = container.clientHeight;

  let idx = cards.findIndex(v=> Math.abs(v.offsetTop - y) < h/2);
  if(idx === -1) idx = Math.round(y / h);

  const target = Math.max(0, Math.min(cards.length-1, idx + dir));
  const top = cards[target]?.offsetTop ?? 0;
  container.scrollTo({ top, behavior: 'smooth' });

  setTimeout(()=>{ isScrolling = false; }, 600);
}, { passive: false });

/* ----------------- 사용자 제스처(오디오 권한) ----------------- */
window.addEventListener('touchstart', ()=>{ userGestureGranted = true; applyAudioPolicy(); }, { once: true });
window.addEventListener('click', ()=>{ userGestureGranted = true; applyAudioPolicy(); }, { once: false });

/* ----------------- 시작 ----------------- */
loadAll();
</script>
</body>
</html>




